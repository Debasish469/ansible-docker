---
# Install the Docker and associated packages, ref: http://stackoverflow.com/questions/29083638/docker-io-has-no-installation-candidated
- hosts: '{{ target }}'
  remote_user: deploy
  sudo: yes
  tasks:
  - name: Make sure apt-transport-https is installed
    # http://docs.ansible.com/apt_module.html
    apt:
      pkg: "apt-transport-https"
      state: installed

  - name: Add Docker repository key
    # http://docs.ansible.com/apt_key_module.html
    apt_key:
      id: "36A1D7869245C8950F966E92D8576A8BA88D21E9"
      keyserver: "hkp://keyserver.ubuntu.com:80"
      state: present

  - name: Add Docker repository and update apt cache
    # http://docs.ansible.com/apt_repository_module.html
    apt_repository:
      repo: "deb http://get.docker.io/ubuntu docker main"
      update_cache: yes
      state: present

  - name: Install lxc-docker
    apt:
      pkg: "lxc-docker"
      state: installed
  
  - name: Install pip
    apt:
      pkg: "{{ item }}"
      state: installed
    with_items:
      - python-dev
      - python-pip

  - name: Install GIT
    apt: 
      pkg: "git"
      state: installed

  - name: Install Nginx
    apt:
      pkg: "{{ item }}"
      state: installed
    with_items"
      - nginx-full
      - nginx

  - name: Install MySQL
    apt:
      pkg: "{{ item }}"
      state: installed
    with_items:
      - mysql-client

  - name: Clone docker-sh git repository
    # http://docs.ansible.com/git_module.html
    git: repo=https://github.com/NETivism/docker-sh.git dest=/etc/ansible/docker-sh accept_hostkey=yes

  - name: Create the directory for docker repository
    # http://docs.ansible.com/file_module.html
    file: path=/etc/ansible/docker owner=root group=root mode=0755 state=directory

  - name: Create the directory for place sites and databases
    # http://docs.ansible.com/file_module.html
    file:
      path: "{{ item }}"
      mode: 0755
      state: directory
    with_items:
      - "/var/www/sites"
      - "/var/mysql/sites"

  - name: Make sure docker is running
    service:
      name: docker
      state: started
