---
  - name: Nginx should be started
    service: name=nginx state=started
    tags:
      - start

  - name: Copy override config file
    copy: src=allow_install_update.conf dest=/etc/nginx/allow_install_update.conf owner=root group=root mode=0644
    tags:
      - start

  - copy: src=allow_install_update_fpm.conf dest=/etc/nginx/allow_install_update_fpm.conf owner=root group=root mode=0644
    tags:
      - start
  - copy: src=fastcgi_custom dest=/etc/nginx/fastcgi_custom owner=root group=root mode=0644
    tags:
      - start

  - name: Copy desired nginx config file
    copy: src={{ type }}.conf dest=/etc/nginx/{{ type }}.conf owner=root group=root mode=0644
    tags:
      - start

  - name: Add Nginx vhost configuration file
    # http://docs.ansible.com/template_module.html
    template: src=nginx.conf.j2 dest=/etc/nginx/sites-available/{{ domain }}
    tags:
      - start

  - name: Link Nginx vhost configuration file in site-enabled
    action: file src=/etc/nginx/sites-available/{{ domain }} dest=/etc/nginx/sites-enabled/{{ domain }} state=link
    notify:
      - validate nginx
    tags:
      - start

  - name: Add site alias into Nginx vhost configuration file
    # http://docs.ansible.com/lineinfile_module.html
    lineinfile: 
      dest: /etc/nginx/sites-available/{{ domain }} 
      regexp: '^(.*)server_name {{ domain }}(.*)$'
      line: '\1server_name {{ domain }} {{ alias }}\2'
      state: present
      backrefs: yes
    tags:
      - alias

  - name: Remove site alias from Nginx vhost configuration file
    lineinfile:
      dest: /etc/nginx/sites-available/{{ domain }}
      regexp: '^(.*) {{ alias }}(.*)$'
      line: '\1\2'
      state: present
      backrefs: yes
    tags:
      - unalias

  - name: Reload nginx
    service: name=nginx state=reloaded
    tags:
      - start
      - reload
      - alias
      - unalias
