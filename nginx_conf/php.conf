error_page 403 =404 /index.php?q=$request_filename;
error_page 404 /index.php?q=$request_filename;

# Compression
gzip on;
gzip_http_version 1.0;
gzip_comp_level 2;
gzip_proxied any;
gzip_min_length  1100;
gzip_buffers 16 8k;
gzip_types text/plain text/css application/x-javascript text/xml application/xml application/xml+rss text/javascript;
# Some version of IE 6 don't handle compression well on some mime-types, 
# so just disable for them
gzip_disable "MSIE [1-6].(?!.*SV1)";
# Set a vary header so downstream proxies don't send cached gzipped 
# content to IE6
gzip_vary on;

# Block access to "hidden" files and directories whose names begin with a
# period. This includes directories used by version control systems such
# as Subversion or Git to store control files.
location ~ /\. {
  return 404;
}

location = /rss.xml {
  try_files $uri @backend;
}

location = /sitemap.xml {
  try_files $uri @backend;
}

location ~ (^/index.php|/civicrm/extern/.+\.php|live/live\.php|/civicrm/bin/civicrm_cron\.php|pubdlcnt\.php|/sites/nettuesday.tw/.+\.php)$ {
  limit_req zone=proxyzone burst=10 nodelay;
  proxy_pass http://127.0.0.1:8080;
  proxy_redirect off;

  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-Server $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
}
## Any other attempt to access PHP files returns a 404.
location ~* ^.+\.php$ {
  return 404;
}

# secure all other drupal directory
location ~* ^/(themes(/.*)?|profiles(/.*)?|modules(/.*)?|includes(/.*)?|sites|sites/[^/]*/.+\.php|sites/all/(modules|themes)(/[^/]*)?(/[^/]*)?|sites/(.*)/(modules|themes)(/[^/]*)?(/[^/]*)?)/?$ {
  return 404;
}


# Support for favicon. Return an 1x1 transparent GIF if it doesn't
location = /favicon.ico {
  expires 30d;
  try_files /favicon.ico @empty;
}
# Return an in memory 1x1 transparent GIF.
location @empty {
  expires 30d;
  empty_gif;
}

#location = / {
#  try_files $uri @backend;
#}

location / {
  # deny access to drupal files
  location ~* (INSTALL\.txt|INSTALL\.*\.txt|CHANGELOG\.txt|phpmyadmin|UPGRADE\.txt|README\.txt|install\.php|update\.php|cron\.php) {
    return 404;
  }

  ## Replicate the Apache <FilesMatch> directive of Drupal standard
  ## .htaccess. Disable access to any code files. Return a 404 to curtail
  ## information disclosure. Hide also the text files.
  ## location ~* ^(?:.+\.(?:htaccess|make|engine|inc|info|install|module|profile|po|sh|.*sql|test|theme|tpl(?:\.php)?|xtmpl|patch)|code-style\.pl|/Entries.*|/Repository|/Root|/Tag|/Template)$ {
  location ~* ^(?:.+\.(?:htaccess|make|engine|inc|info|install|module|profile|po|sh|.*sql|test|theme|tpl(?:\.php)?|xtmpl|patch)|code-style\.pl|/Entries.*|/Repository|/Root|/Template)$ {
    return 404;
  }

  # allow for custom
  location ~* /files/civicrm/(custom|persist)/ {
    allow all;
    try_files $uri 404;
  }

  # deny for civicrm
  location ~* /files/civicrm/ {
    return 404;
  }

  # no for private
  location ~* /files/private/ {
    internal;
  }

  location ^~ /system/files/ {
    try_files $uri @backend;
    log_not_found off;
  }

  ## If accessing an image generated by Drupal 7 image style , serve it
  ## directly if available, if not relay the request to Drupal to (re)generate
  ## the image.
  location ~* /styles/ {
    ## Image hotlinking protection. If you want hotlinking
    ## protection for your images uncomment the following line.
    #include apps/drupal/hotlinking_protection.conf;

    access_log off;
    expires 30d;
    try_files $uri @backend;
  }

  # image
  location ~* ^.+\.(?:css|cur|js|jpe?g|gif|htc|ico|png|html|xml)$ {
    access_log off;
    expires 30d;
    ## No need to bleed constant updates. Send the all shebang in one
    ## fell swoop.
    tcp_nodelay off;
    ## Set the OS file cache.
    open_file_cache max=3000 inactive=120s;
    open_file_cache_valid 45s;
    open_file_cache_min_uses 2;
    open_file_cache_errors off;
    ## ETag support. This requires an Nginx version >= 1.3.3.
    etag on;
  }
  #try_files $uri /$uri @backend;
  try_files $uri /$uri @cache;
}

location @cache {
  if ( $request_method !~ GET ) {
    return 405;
  }
  if ($http_cookie ~ "DRUPAL_UID") {
    return 405;
  }
  error_page 405 = @backend;

  add_header    Cache-Control  private;
  add_header X-Header "Boost";
  try_files /cache/normal/$host${uri}_$args.html @backend;
}

location @backend {
  limit_req zone=proxyzone burst=10 nodelay;
  proxy_pass http://127.0.0.1:8080;
  proxy_redirect off;

  proxy_set_header Host $host;
  proxy_set_header X-Real-IP        $remote_addr;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-Server $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
  proxy_set_header X-Forwarded-Proto $scheme;

  client_max_body_size 20m;

  proxy_connect_timeout 60;
  proxy_send_timeout 60;
  proxy_read_timeout 14400; # 4hr
}

